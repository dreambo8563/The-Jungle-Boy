<!doctype html>
<html>

<head>
  <script src="./pixi.js"></script>
  <script src="https://unpkg.com/@pixi/sound/dist/pixi-sound.js"></script>
  <script src="./utils.js"></script>
  <script src="./events.js"></script>
  <script src="./enemy.js"></script>
  <script src="./initLoad.js"></script>
</head>
<style>
  * {
    margin: 0;
    padding: 0;
  }

  html {
    overflow: hidden;
  }
</style>

<body>
  <script>
    // Create the application helper and add its render target to the page
    let app = new PIXI.Application({ background: '#1099bb', resizeTo: window });
    document.body.appendChild(app.view);

    const bg = PIXI.Sprite.from('./images/bg.jpg')
    bg.width = app.screen.width
    bg.height = app.screen.height
    PIXI.sound.add('stage1', {
      url: './sound/stage1.wav',
      loop: true,

    });

    PIXI.sound.play('stage1');
    app.stage.addChild(bg)
    init().then(() => {
      loadEnemy()
      setInterval(() => {
        loadEnemy()
      }, 1000);
    })


    const ActionMap = {
      idle: animateGroup("Idle"),
      runs: animateGroup("Run"),
      jumps: animateGroup("Jump"),
      slide: animateGroup("Slide"),
      attack: animateGroup("Attack"),
      jumpAttack: animateGroup("Jump_Attack"),
      throw: animateGroup("Throw"),
      jumpThrow: animateGroup("Jump_Throw"),
    }


    // 飞镖的集合
    let Darts = []
    let current = loadAction(window.innerWidth / 2, app.screen.height - 200, "idle")

    app.stage.addChild(current);

    let duration = 0

    // // Listen for frame updates
    app.ticker.add(() => {

      // 控制飞镖
      Darts.forEach(async (dart, index) => {
        if (KillingWeaponMap[dart.id]) {
          return
        }
        const i = enemies.findIndex(enemy => {
          return !KilledEnemyMap[enemy.id] && enemy.y === dart.y && checkHit(dart, enemy)
        })
        if (i == -1) {
          if (dart.x > window.innerWidth) {
            app.stage.removeChild(dart)
            Darts.splice(index, 1)
          } else {
            dart.x += 10
          }
          return
        }
        KillingWeaponMap[dart.id] = true
        KilledEnemyMap[enemies[i].id] = true
        // 杀死敌人效果
        await loadSmoke(dart.x, dart.y)
        app.stage.removeChild(dart)
        Darts = Darts.filter(item => item.id !== dart.id)
        app.stage.removeChild(enemies[i])
        enemies = enemies.filter(item => item.id !== enemies[i].id)


      })


      if (left.isDown) {
        left.press();
      }
      if (right.isDown) {
        right.press();
      }

      if (current.name === 'jumps') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        if (duration < 10) {
          current.y -= 5
          current.x += 5
        }
        if (duration >= 10 && duration < 20) {
          current.y += 5
          current.x += 5
        }

        current.x = Math.min(current.x, window.innerWidth)
        duration++
      }
      if (current.name === 'slide') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        if (duration < 10) {
          current.x += 5
        }
        if (duration >= 10 && duration < 20) {
          current.x += 2
        }
        current.x = Math.min(current.x, window.innerWidth)
        duration++
      }
      if (current.name === 'attack') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        duration++
      }
      if (current.name === 'throw') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        duration++
      }
      if (current.name === 'jumpAttack') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        if (duration < 10) {
          current.y -= 5
          current.x += 5
        }
        if (duration >= 10 && duration < 20) {
          current.y += 5
          current.x += 5
        }

        current.x = Math.min(current.x, window.innerWidth)
        duration++
      }

      if (current.name === 'jumpThrow') {
        if (duration >= 20) {
          switchToAction("idle")
          return
        }
        if (duration < 10) {
          current.y -= 5
        }
        if (duration === 10) {
          Darts.push(createDart())
          current.y += 5
        }
        if (duration > 10 && duration < 20) {
          current.y += 5
        }

        current.x = Math.min(current.x, window.innerWidth)
        duration++
      }


      enemies.forEach((enemy, index) => {
        if (enemy.x < 0) {
          app.stage.removeChild(enemy)
          enemies.splice(index, 1)
        } else {
          enemy.x -= 1
        }
      })

    })
  </script>
</body>

</html>